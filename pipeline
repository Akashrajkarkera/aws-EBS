pipeline {
  agent any

  environment {
    AWS_REGION = 'ap-south-1'
    AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')
    AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
  }

  stages {
    stage('Build') {
      steps {
        sh 'npm install'
        sh 'npm run build'
        zip zipFile: 'myapp.zip', archive: false, dir: 'build'
      }
    }

    stage('Deploy') {
      steps {
        withAWS(region: AWS_REGION, credentials: 'aws-credentials') {
          def versionLabel = "${env.JOB_NAME}-${env.BUILD_NUMBER}"
          def bucketName = "elasticbeanstalk-us-west-2-${AWS_ACCESS_KEY_ID}"
          s3Upload(file: 'myapp.zip', bucket: bucketName, path: "builds/${versionLabel}.zip")
          elasticBeanstalk(
            applicationName: 'myapp',
            environmentName: 'myapp-dev',
            bucketName: bucketName,
            key: "builds/${versionLabel}.zip",
            versionLabel: versionLabel
          )
        }
      }
    }
  }
}
